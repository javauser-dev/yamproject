<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
	layout:decorate="~{template/client/layout/layout}">
	
	<th:block layout:fragment="content">
		<div class="text-center"><h3>게시판 상세</h3></div>
		
		<div class="container" th:object="${detail}"> 
			<div class="board-table-height">
				<form id="dataForm">
					<input type="hidden" name="no" th:value="*{no}" />	
				</form>
				
				<table class="table table-bordered">
					<tbody class="text-center">
						<tr>
							<td class="col-md-3">작성자</td>
							<td class="col-md-3 text-start" th:text="*{name} + ' (조회수: ' + *{hit} + ')'"></td>
							<td class="col-md-3">작성일</td>
							<td class="col-md-3 text-start" th:text="*{#temporals.format(regDate, 'yyyy-MM-dd HH:mm:ss')}"></td>
						</tr>
						<tr>
							<td class="col-md-3">글제목</td>
							<td colspan="3" class="col-md-9 text-start" th:text="*{title}"></td>
						</tr>
						<!-- 여기에 원래는 글내용이랑 이미지가 따로 있었는데 합침. 0304 16:00 -->
						<tr class="board-table-tr-height" th:if="*{not #strings.isEmpty(filename)}">
							<td class="col-md-3 align-middle">글내용</td>
							<td colspan="3" class="col-md-9 text-start" th:utext="${#strings.replace(detail.content, newLine, '&lt;br /&gt;')}"><img th:src="@{/board/view/} + *{filename}" /></td>
						</tr>					
					</tbody>
				</table>	
			</div>	  			
  			<div class="col-md-3 text-end">
  				<button type="button" id="updateFormBtn" class="btn btn-primary btn-sm">글수정</button>
				<button type="button" id="boardDeleteBtn" class="btn btn-primary btn-sm">글삭제</button>
				<button type="button" id="insertFormBtn" class="btn btn-primary btn-sm">글쓰기</button>
				<button type="button" id="boardListBtn" class="btn btn-primary btn-sm">글목록</button>
  			</div>
  			
  			<!--/*댓글화면구현(comment) 아티클디테일에서 가져옴 0304 16:20*/-->
  			<form id="commentForm">
  				<input type="hidden" name="id" id="id" value="0" />
				<div class="row mb-3">
					<label for="nickname" class="col-sm-1 col-form-label">작성자</label>
					<div class="col-sm-3">
						<input type="text" name="nickname" id="nickname" maxlength="8" class="form-control" />
					</div>
					<button type="button" id="commentInsertBtn" class="btn btn-secondary col-sm-1 sendBtn mx-2">저장</button>
				</div>
				<div class="row mb-3">
					<label for="body" class="col-sm-1 col-form-label">댓글내용</label>
					<div class="col-sm-11">
						<textarea name="body" id="body" class="form-control" rows="3"></textarea>
					</div>
				</div>
			</form>
		</div>
	</th:block>		
		
	<th:block layout:fragment="script">
		<script src="/js/storeCommunity/storeCommunityCommon.js"></script>
		<script src="/js/storeCommunity/storeCommunityDetail.js"></script>
		<!-- 아티클디테일에서 가져온 아래 스크립트 추가 0304 16:30 -->
		<script> 
			const dataReset = () => {
				$("#commentForm").each(function(){
					this.reset();
				});
			}
			
			const addCommentToList = (comment) => {
			    let template = `
			        <div class="card mb-2 comment" data-id="${comment.id}">
			            <h5 class="card-header">
			                <span class="name">${comment.nickname}</span>
			                <span class="cdate">${new Date(comment.cdate).toLocaleString()}</span>
			                <a href="#" class="btn btn-secondary btn-sm commentUpdateFormBtn">수정</a>
			                <a href="#" class="btn btn-secondary btn-sm commentDeleteBtn">삭제</a>
			            </h5>
			            <div class="card-body">
			                <p class="card-text">${comment.body}</p>
			            </div>
			        </div>
			    `;
			    $("#commentList").append(template); // 새 댓글을 댓글 리스트에 추가
			}
			
			let no = $("#no").val();
			$(document).on("click", "#commentInsertBtn", function(){ 
				if (!checkForm("#nickname","작성자를"))  return; 
				else if (!checkForm("#body","내용을"))  return;
				else {
					/* JSON.stringify(): JavaScript 값이나 객체를 JSON 문자열로 변환. */
					$.ajax({
						url : "/comments/commentInsert",     //전송 url
						method : "post",    // 전송 시 method 방식
						headers : {
							"Content-Type":"application/json"
						},
						data : JSON.stringify({
							nickname:$("#nickname").val(),
							body:$("#body").val(),
							article:{
								no:no
							}
						}),
						dataType:"json"
					}).done(function(data){	
						if(data!=""){
							alert("댓글 등록이 완료되었습니다.");
							//let data = JSON.parse(result);
							dataReset();
							addCommentToList(data)
						}
					}).fail(function(){
						alert("시스템에 문제가 있어 잠시 후 다시 진행해 주세요.");
					});	
				}
			});

			$(document).on("click", ".commentUpdateFormBtn", function(e){ 
				e.preventDefault();
				$("#commentForm .resetBtn").detach();
						
				let card = $(this).parents("div.comment");
				$("#id").val(card.data("id"));
				$("#nickname").val(card.find(".card-header .name").html());
				$("#nickname").prop("readonly", true);
					
				let body = card.find(".card-text").html();
				body = body.replace(/(<br>|<br\/>|<br \/>)/g, '\r\n'); 
				$("#body").val(body);
				
				$("#commentForm button[type='button']").attr("id", "commentUpdateBtn");
				let resetButton = $("<button type='button' class='btn btn-secondary col-sm-1 resetBtn mx-2'>");
				resetButton.html("취소");
				$("#commentForm .sendBtn").after(resetButton);

			});

			const init = () =>{
				$("#nickname").prop("readonly", false);
				$("#commentForm button[type='button']").attr("id", "commentInsertBtn");
				$("#commentForm button[type='button'].resetBtn").detach();
				$("#id").val(0);
			};

			$(document).on("click", ".resetBtn", function(){ 
				dataReset();
				init();
			});

			$(document).on("click", "#commentUpdateBtn", function(){
				let commentId = $("#id").val();	
				if (!checkForm("#body","댓글내용을"))	return;
				else {
					
					$.ajax({
						url:'/comments/'+commentId,
						method:'put',
						headers: { 
							"Content-Type": "application/json",
						},
						data:JSON.stringify({
							body:$("#body").val()
						}), 
						dataType:'json'
					}).done(function(data){
						if(data != ""){
							alert("댓글 수정이 완료되었습니다.");
							dataReset();
							//console.log(data.body);
							$(".resetBtn").remove();
							init();
							$('#commentList').find("div[data-id="+commentId+"]").find(".card-text").html(data.body.replace(/(\r\n|\r|\n)/g, "<br />"));
						}
					}).fail(function(){
						alert("시스템에 문제가 있어 잠시 후 다시 진행해 주세요.");
					});
				}
			}); 

			$(document).on("click", ".commentDeleteBtn", function(e){ 
				e.preventDefault();
				let commentDeleteDataArea = $(this).parents("div.comment");
				let commentId = commentDeleteDataArea.data("id");
				console.log(commentId);
				if (confirm("선택하신 댓글을 삭제하시겠습니까?")) {
					$.ajax({
						url : '/comments/'+commentId, 
						method : 'delete',   // method - get(조회-R)/post(입력-C)/put(수정-U)/delete(삭제-D) 명시
						dataType : 'text'
					}).done(function(){	
						//alert("댓글 삭제가 완료되었습니다.");
						commentDeleteDataArea.remove();
					}).fail(function(){
						alert("시스템에 문제가 있어 잠시 후 다시 진행해 주세요.");
					});	
				} 
			});
		</script>
	</th:block>	
</html>		