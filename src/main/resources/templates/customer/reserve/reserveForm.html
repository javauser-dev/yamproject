<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>예약하기</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- 네이버 페이 SDK 추가 (경로는 실제 SDK 경로에 맞게 수정) -->
    <script src="https://nsp.pay.naver.com/sdk/js/naverpay.min.js"></script>
</head>
<body>
    <h1>예약 정보</h1>

    <form id="reserveForm">
        <div>
            <label for="customerId">고객 ID:</label>
            <input type="text" id="customerId" name="customerId" th:value="${customerId}" readonly>
        </div>
        <div>
            <label for="shopId">매장 ID:</label>
            <input type="text" id="shopId" name="shopId" th:value="${reserveDto.shopId}" readonly>
        </div>
        <div>
            <label for="reserveDate">예약 날짜:</label>
            <input type="date" id="reserveDate" name="reserveDate" th:value="${reserveDto.reserveDate}" readonly>
        </div>
        <div>
            <label for="reserveTime">예약 시간:</label>
            <input type="time" id="reserveTime" name="reserveTime" th:value="${reserveDto.reserveTime}" readonly>
        </div>
        <div>
            <label for="guestCount">인원 수:</label>
            <input type="number" id="guestCount" name="guestCount" th:value="${reserveDto.guestCount}" readonly>
        </div>
        <div>
            <label for="deposit">예약금:</label>
            <input type="number" id="deposit" name="deposit" th:value="${reserveDto.deposit}" readonly>
        </div>
        <div>
            <label for="request">요청사항:</label>
            <textarea id="request" name="request"></textarea>
        </div>

        <button type="button" id="naverPayBtn">네이버페이로 결제</button>  <!-- 결제 버튼 -->
        <button type="button" id="submitBtn" style="display:none;">예약하기</button> <!--실제 예약 post 요청-->
    </form>

    <script>
        $(document).ready(function() {

           // 네이버페이 결제 연동
           var oPay = Naver.Pay.create({
		        "mode" : "development",
		        "clientId": "HN3GGCMDdTgGUfl0kFCo",
		        "chainId": "b1NiUjJIcGlIZ3B"
		    });

            $("#naverPayBtn").click(function() {
               // 1. 결제 정보 생성 (여기서는 예약금을 결제한다고 가정)
                var paymentAmount = parseInt($("#deposit").val());

                oPay.open({
                  "merchantUserKey": $("#customerId").val(),
                  "merchantPayKey": "order-" + new Date().getTime(), //고유 주문번호
                  "productName": "예약금 결제",
                  "totalPayAmount": paymentAmount,
                  "taxScopeAmount": paymentAmount, //과세
                  "taxExScopeAmount": 0,        //면세
                  "returnUrl": "http://localhost:8080/customer/reserve/payment-success" // 결제 성공 후 리다이렉트될 URL (컨트롤러 필요)
                });

            });

            $("#submitBtn").click(function() { //실제 예약하기
                var formData = { // JSON 객체로 데이터 생성
                    shopId: parseInt($("#shopId").val()),
                    reserveDate: $("#reserveDate").val(),
                    reserveTime: $("#reserveTime").val(),
                    guestCount: parseInt($("#guestCount").val()),
                    deposit: parseInt($("#deposit").val()),
                    request: $("#request").val()
                };

                $.ajax({
                    type: "POST",
                    url: "/customer/reserve/new",
                    contentType: "application/json", // JSON 형태로 보낼 것임을 명시
                    data: JSON.stringify(formData), // JSON 문자열로 변환
                    success: function(response) {
                        alert(response);  // 예약 성공 메시지 표시
                        // 예약 성공 후 페이지 이동 (예: 예약 확인 페이지)
                         window.location.href = "/customer/reserve/confirmation?reserveId=" + response.split("예약 번호: ")[1]; // 예약 번호 파싱
                    },
                    error: function(xhr, status, error) {
                        alert("예약 실패: " + xhr.responseText);
                    }
                });
            });

        });
    </script>
</body>
</html>